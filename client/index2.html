<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WebSocket Client</title>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
  <h2>Cliente WebSocket con JWT</h2>
  <button onclick="connect()">Conectar</button>
  <button onclick="disconnect()">Desconectar</button>
  <br/><br/>
  <input id="receiver" type="text" placeholder="Email receptor"/>
  <input id="message" type="text" placeholder="Mensaje"/>
  <button onclick="sendMessage()">Enviar</button>
  <ul id="messages"></ul>

  <script>
    let stompClient = null;
    let token = null;

    // 1. Hacer login para obtener JWT
    async function login() {
      const response = await fetch("http://localhost:9890/api/v1/auth", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          email: "luis.io12@empresa.com",
          password: "123456"
        })
      });

      const dataResponse = await response.json();
      token = dataResponse.data.accessToken; // según tu AuthResponse
      console.log("Token obtenido:", token);
    }

    // 2. Conectar WebSocket
    async function connect() {
      if (!token) await login();

      const socket = new SockJS("http://localhost:9890/ws");
      stompClient = Stomp.over(socket);

      stompClient.connect(
        { Authorization: "Bearer " + token },
        (frame) => {
          console.log("Conectado:", frame);

          // 3. Suscribirse a mensajes privados
          stompClient.subscribe("/user/queue/messages", (message) => {
            const msg = JSON.parse(message.body);
            showMessage(`De: ${msg.sender} - ${msg.content}`);
          });
        },
        (error) => console.error("Error de conexión:", error)
      );
    }

    // 3. Enviar mensaje privado
    function sendMessage() {
      const sender = "luis.io12@empresa.com";
      const receiver = document.getElementById("receiver").value;
      const content = document.getElementById("message").value;
      const type = "TEXT";

      stompClient.send(
        "/app/chat.private",
        { Authorization: "Bearer " + token },
        JSON.stringify({ sender, receiver, content, type })
      );

      showMessage(`De: ${sender} - ${content}`);
    }

    // 4. Desconectar
    function disconnect() {
      if (stompClient) {
        stompClient.disconnect(() => {
          console.log("Desconectado");
        });
      }
    }

    // Mostrar mensajes en pantalla
    function showMessage(message) {
      const li = document.createElement("li");
      li.innerText = message;
      document.getElementById("messages").appendChild(li);
    }
  </script>
</body>
</html>
